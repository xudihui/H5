1、支付宝和微信是现在移动端的大平台，这几年来杭州市民卡一直在微信中建设迭代传统卡的线上服务，把繁琐的线下流程直接搬到线上运行，大大提高了杭州市民卡的用卡体验。今年六月份也在支付宝中上线了虚拟公交卡项目、虚拟社保卡等项目,实现了公交和医疗两大领域的无卡化目标。

2、由于微信平台的开发文档比较详细，之前的结束的项目中，除了城市服务和微信团队有过技术对接，其它项目参考官网文档，基本能满足需求，但这次在支付宝容器中完成的虚拟公交卡项目，还是就遇到了一些小坎坷。

3、离线包跳出来的webView实例不支持hash路由，所有的返回直接关闭webView。
这个问题和支付宝前端沟通之后，他们前期让我们先用容器的pushWindow接口做路由，后期他们升级支付宝钱包版本来支持hash路由。

4、切换支付宝的登录账号，不会清空localStorage
这对应用离线数据的存储更新带来了一个大坑，本来我可以用auth_base静默授权只拿一次alipayId，然后一直存储在localStorage里面。每次进应用只要判断localStorage是否有alipayId，有的话直接可以用它去查询是否开过卡（未开卡路由引导至开卡页面；已开卡路由引导至卡详情页面），没有的话就再次调用auth_base获取它。按照这个逻辑的话，我就可以对用户信息接口做到最小频率请求了，除非用户切换账号，否则只要请求一次就可以了，但是是否开卡还是要保持每次请求，因为用户的卡状态会变化。
由于切换账号不会清空，导致每次都要去请求alipayId，对比新旧的值，如果有变（切换支付宝账号），就更新，大大增加了这个接口的访问频率。当然这个问题在旧版本的ios微信中也存在，最新版的微信已经修正了该bug。

5、存放在https协议的网页，无法在容器中引用http的js和css资源，图片资源可以正常引用。
为了安全起见，部署上线后采用ssl加密传输，导致原先在cdn上的http静态资源无法在容器中引用，在pc端会警告，但是不影响页面打开，在支付宝容器中直接卡在进度条中，无法呈现页面。最后把cdn上的资源更新到https解决。（在http的网页中引用https资源是完全允许的）

6、之前在微信中一直用腾讯地图lbs服务开发地图相关场景，由于竞对企业，支付宝直接屏蔽了对腾讯地图的支持，无奈我只能用高德地图在支付宝容器中进行地图相关功能开发，开发阶段，用微信和支付宝调试地图功能都正常（此处要给腾讯一个赞，至少没在微信中屏蔽高德地图），但是上线那晚，我发现线上的版本始终无法在支付宝中显示出网页(仅限4G环境下)，当时的我真的非常诧异，内测一直好好的，部署到线上就无法打开了，我怀疑是服务器部署问题，马上拉上后台人员一起帮忙查看，因为页面提示一直是：ERR_CONTENT_LENGTH_MISMATCH：我通过论坛查了下，有可能是Nginx 做反向代理，后端是 tomcat，chrome 浏览器访问项目时加载大文件失败导致的。后台也认可我这个观点，因为我们确实用了nginx做负载均衡，他们马上着手帮忙解决，于此同时我也开始在前端排查问题，重新审核了一遍代码排除了卡住线程的代码，甚至把自己写的业务逻辑js全部删除还是无法显示。经过两个小时的攻坚排查，最后通过一行一行人肉删除外部引用的js时，发现删除高德地图之后，网页就可以访问了。马上把收获返回给服务端人员，太好了，终于把问题缩小了。服务端人员结果努力后告诉我，他们确实发现了有一个负载均衡的代码，会限制文件请求，但是修改之后依然无效，这时我们又陷入了无尽思索，此时我们技术主管刚好路过，在和我们一番交涉之后，他第一时间定位到是公司waf防火墙把我们屏蔽了，马上联系技术部人员帮我们一起排查，果然，最后是因为高德地图调用了支付宝的相关服务，倒是waf认为这是有风险的行为，直接把我们屏蔽了，最后联系风控部帮我们开了白名单，项目才恢复正常展示。下次再遇到此类问题的时候要继续发挥人肉定位问题的精神，把问题定位到最小，当然，也可以提前联系下技术部，看看是否被屏蔽了。不要一味扑在业务代码层，多跳出当前的思考范围，有可能是网络屏蔽呢。

7